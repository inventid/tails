// Tails
// version: 0.0.1
// contributors: Joost Verdoorn
// license: MIT
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a={Mixins:{},Models:{},Views:{},config:{url:"http://localhost"}},a.Mixins.Interceptable={InstanceMethods:{before:function(a){return this.intercept({before:a})},after:function(a){return this.intercept({after:a})},intercept:function(a){var c,d,e,f,g,h,i,j,k,l,m,n;h=this.constructor||this,n=[];for(i in a)if(e=a[i],"before"===i||"after"===i){if(null!=e.these)for(m=e.these,k=0,l=m.length;l>k;k++){if(g=m[k],"function"==typeof g)for(f in this)if(j=this[f],g===j){g=f;break}e[g]=e["do"]}e=_(e).omit("these","do"),n.push(function(){var a;a=[];for(g in e)d=e[g],_(d).isArray()||(d=[d]),a.push(function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)c=d[a],f.push(function(a){return function(c,d){var e,f,g,j,k,l,m,n;return(a.hasOwnProperty(c)||h.prototype.hasOwnProperty(c))&&null==a[c].before&&null==a[c].after?(g=a[c],a[c]=function(){var a,c;return a=1<=arguments.length?b.call(arguments,0):[],"before"===i&&(this[d]||d).apply(this,a),c=g.apply(this,a),"after"===i&&(this[d]||d).apply(this,a),c}):(f=(null!=(k=a[c])?k.klass:void 0)===h&&null!=(l=a[c])?l.before:void 0,e=(null!=(m=a[c])?m.klass:void 0)===h&&null!=(n=a[c])?n.after:void 0,"before"===i?(j=f,f=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],null!=j&&j.apply(this,a),(this[d]||d).apply(this,a)}):"after"===i&&(j=e,e=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],(this[d]||d).apply(this,a),null!=j?j.apply(this,a):void 0}),Object.defineProperty(a,c,{configurable:!0,set:function(a){return delete this[c],this[c]=function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,c),d=a.apply(this,c),null!=e&&e.apply(this,c),d}},get:function(){var a;return a=function(){var a,d,g,i;return a=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,a),g=null!=(i=this.constructor.__super__)?i[c]:void 0,(null!=g?g.klass:void 0)!==h&&(d=null!=g?g.apply(this,a):void 0),null!=e&&e.apply(this,a),d},a.before=f,a.after=e,a.klass=h,a}}))}}(this)(g,c));return f}.call(this));return a}.call(this))}return n}},ClassMethods:{before:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.before(a.call(this))}}):this.prototype.before(a)},after:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.after(a.call(this))}}):this.prototype.after(a)}}},a.Mixins.DynamicProperties={InstanceMethods:{getter:function(a){return this.defineProperty({getter:a})},setter:function(a){return this.defineProperty({setter:a})},defineProperty:function(a){var b,c,d,e,f;f=[];for(e in a)b=a[e],("getter"===e||"setter"===e)&&f.push(function(){var a;a=[];for(d in b)c=b[d],a.push(function(a){return function(b,c){var d;return d=Object.getOwnPropertyDescriptor(a,b)||{configurable:!0},"getter"===e?d.get=function(){return c.call(a)}:"setter"===e&&(d.set=function(b){return c.call(a,b)}),Object.defineProperty(a,b,d)}}(this)(d,c));return a}.call(this));return f}},ClassMethods:{getter:function(a){return this.before({initialize:function(){return this.getter(("function"==typeof a?a():void 0)||a)}})},setter:function(a){return this.before({initialize:function(){return this.setter(("function"==typeof a?a():void 0)||a)}})}},extended:function(){return this.concern(a.Mixins.Interceptable)}},a.Mixins.Collectable={ClassMethods:{all:function(){var b;return(null!=(b=this._all)?b.klass:void 0)!==this&&(this._all=new a.Collection(null,{model:this}),this._all.klass=this),this._all},get:function(a){return this.all().get(a)||new this({id:a})}},extended:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.id&&null!=this.constructor.all().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.all().add(this)}})}},a.Mixins.Relations={InstanceMethods:{belongsTo:function(a){var b,c,d,e,f;b=a.foreignKey,e=_(a).omit("foreignKey"),f=[];for(c in e)d=e[c],f.push(function(a){return function(b,c,d){var e,f;return b||(b=inflection.foreign_key(d.name)),e=a.get(b),f=a.get(c),a.unset(b,{silent:!0}),a.unset(c,{silent:!0}),Object.defineProperty(a.attributes,c,{get:function(){return d.get(a.get(b))},set:function(c){return null==d.get(c.id)&&d.create(c),a.set(b,c.id)}}),a.on("change:"+b,function(){var e,f;return e=a.get(c),f=d.get(a.previous(b)),null!=e&&e!==f?(f&&a.stopListening(f),a.trigger("change:"+c,a,e),a.listenTo(e,"change:id",function(c,d){return a.set(b,d)})):void 0}),null!=f?a.set(c,f):null!=e?a.set(b,e):void 0}}(this)(b,c,d));return f},hasOne:function(a){var b,c,d,e,f;b=a.foreignKey,e=_(a).omit("foreignKey"),f=[];for(c in e)d=e[c],f.push(function(a){return function(b,c,d){var e;return b||(b=inflection.foreign_key(a.constructor.name)),e={},e[b]=a.id,Object.defineProperty(a.attributes,c,{get:function(){return d.all().findWhere(e)||new d(e)},set:function(d){return a.attributes(c)[b]=void 0,d[b]=a.id}})}}(this)(b,c,d));return f},hasMany:function(b){var c,d,e,f,g;c=b.foreignKey,f=_(b).omit("foreignKey"),g=[];for(d in f)e=f[d],g.push(function(b){return function(c,d,e){var f;return c||(c=inflection.foreign_key(b.constructor.name)),f=new a.Collection(null,{model:e,parent:b}),b.set(d,f),f.add(e.all().find(function(a){return a.get(c)===b.id})),e.all().on("change:"+c,function(a,c){return c!==b.id&&f.contains(a)?f.remove(a):c!==b.id||f.contains(a)?void 0:f.add(a)}),e.all().on("add",function(a){return a.get(c)!==b.id||f.contains(a)?void 0:f.add(a)}),e.all().on("remove",function(a){return a.get(c)===b.id&&f.contains(a)?f.remove(a):void 0}),f.on("add",function(a){return a.get(c)!==b.id?a.set(c,b.id):void 0}),f.on("remove",function(a){return a.get(c)===b.id?a.set(c,void 0):void 0})}}(this)(c,d,e));return g}},ClassMethods:{belongsTo:function(a){return this.before({initialize:function(){return this.belongsTo(("function"==typeof a?a():void 0)||a)}})},hasOne:function(a){return this.before({initialize:function(){return this.hasOne(("function"==typeof a?a():void 0)||a)}})},hasMany:function(a){return this.before({initialize:function(){return this.hasMany(("function"==typeof a?a():void 0)||a)}})}},extended:function(){return this.concern(a.Mixins.Collectable),this.concern(a.Mixins.Interceptable)}},a.Mixable={include:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._includedMixins)?i.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._includedMixins,d)<0){j=d.InstanceMethods;for(a in j)f=j[a],this.prototype[a]=f;this._includedMixins.push(d),null!=(k=d.included)&&k.apply(this)}return this},extend:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._extendedMixins)?i.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._extendedMixins,d)<0){j=d.ClassMethods;for(a in j)f=j[a],this[a]=f;this._extendedMixins.push(d),null!=(k=d.extended)&&k.apply(this)}return this},concern:function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.include.apply(this,a),this.extend.apply(this,a),this}},a.Model=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.concern(a.Mixins.Relations),c.prototype.format="json",c.prototype.initialize=function(a,b){var d;return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent||(null!=(d=this.collection)?d.parent:void 0),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.constructor.name,["underscore","pluralize"])},c.prototype.url=function(){var b,c,d,e,f,g,h;return b=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||a.config.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+b+"/"+e+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.save=function(a){return null==a&&(a={}),c.__super__.save.call(this,_.defaults(a,{dataType:this.format}))},c}(Backbone.Deferred.Model),a.Collection=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.format="json",c.prototype.initialize=function(b,d){return null==b&&(b=null),null==d&&(d={}),this.model=d.model||this.model||a.Model,this.parent=d.parent||this.parent,c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.model.name,["underscore","pluralize"])},c.prototype.url=function(){var b,c,d,e,f,g;return b=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||a.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+b+"/"+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),d.push(c)}return d},c}(Backbone.Deferred.Collection),a.Template=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.concern(a.Mixins.Collectable),c.prototype.urlRoot="assets",c.prototype.format="html",c.prototype.bind=function(a){return this.fetch({parse:!0}).then(function(b){return function(){var c;return c=b.get("$el").clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(a.Model),a.View=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.initialize=function(a){var b;return null==a&&(a={}),null!=(b=this.template)&&b.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.apply(this,arguments)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),a.factory=function(b){return b._=a,b.Mixable=a.Mixable,b.Model=a.Model,b.Collection=a.Collection,b.View=a.View,b.Template=a.Template,b.Mixins=a.Mixins,b.Models=a.Models,b.Views=a.Views,b.config=a.config,b.configure=function(b){var c,d;null==b&&(b={});for(c in b)d=b[c],a.config[c]=d}},"object"==typeof exports?a.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(b){return a.factory(this.Tails=b),b}):a.factory(this.Tails={})}).call(this);