// Tails
// version: 0.0.2
// contributors: Joost Verdoorn,Steffan Sluis
// license: MIT
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d={}.hasOwnProperty,e={}.__proto__.constructor.defineProperty,f={}.__proto__.constructor.getOwnPropertyDescriptor,g=function(a,b){function c(){this.constructor=a}for(var g in b)d.call(b,g)&&e(a,g,f(b,g));return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a={Mixins:{},Utils:{},Models:{},Views:{},config:{url:"http://localhost"}},a.Utils.Hash=function(a){var b,c,d,e,f;if(c=0,0===a.length)return c;for(d=e=0,f=a.length;f>=0?f>e:e>f;d=f>=0?++e:--e)b=a.charCodeAt(d),c=(c<<5)-c+b,c&=c;return c},a.Mixins.Interceptable={InstanceMethods:{before:function(a){return this.intercept({before:a})},after:function(a){return this.intercept({after:a})},intercept:function(a){var c,d,e,f,g,h,i,j,k,l,m,n;h=this.constructor||this,n=[];for(i in a)if(e=a[i],"before"===i||"after"===i){if(null!=e.these)for(m=e.these,k=0,l=m.length;l>k;k++){if(g=m[k],"function"==typeof g)for(f in this)if(j=this[f],g===j){g=f;break}e[g]=e["do"]}e=_(e).omit("these","do"),n.push(function(){var a;a=[];for(g in e)d=e[g],_(d).isArray()||(d=[d]),a.push(function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)c=d[a],f.push(function(a){return function(c,d){var e,f,g,j,k,l,m,n;return(a.hasOwnProperty(c)||h.prototype.hasOwnProperty(c))&&null==a[c].before&&null==a[c].after?(g=a[c],a[c]=function(){var a,c;return a=1<=arguments.length?b.call(arguments,0):[],"before"===i&&(this[d]||d).apply(this,a),c=g.apply(this,a),"after"===i&&(this[d]||d).apply(this,a),c}):(f=(null!=(k=a[c])?k.klass:void 0)===h&&null!=(l=a[c])?l.before:void 0,e=(null!=(m=a[c])?m.klass:void 0)===h&&null!=(n=a[c])?n.after:void 0,"before"===i?(j=f,f=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],null!=j&&j.apply(this,a),(this[d]||d).apply(this,a)}):"after"===i&&(j=e,e=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],(this[d]||d).apply(this,a),null!=j?j.apply(this,a):void 0}),Object.defineProperty(a,c,{configurable:!0,set:function(a){return delete this[c],this[c]=function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,c),d=a.apply(this,c),null!=e&&e.apply(this,c),d}},get:function(){var a;return a=function(){var a,d,g,i;return a=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,a),g=null!=(i=this.constructor.__super__)?i[c]:void 0,(null!=g?g.klass:void 0)!==h&&(d=null!=g?g.apply(this,a):void 0),null!=e&&e.apply(this,a),d},a.before=f,a.after=e,a.klass=h,a}}))}}(this)(g,c));return f}.call(this));return a}.call(this))}return n}},ClassMethods:{before:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.before(a.call(this))}}):this.prototype.before(a)},after:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.after(a.call(this))}}):this.prototype.after(a)}}},a.Mixable={MixableKeywords:["included","extended","constructor","Interactions","InstanceMethods","ClassMethods"],_include:function(b){var d,e,f,g;if(null!=b.InstanceMethods)d=b.InstanceMethods;else{if(null!=b.ClassMethods)return;d=b}for(e in d)f=d[e],c.call(a.Mixable.MixableKeywords,e)<0&&null!=f&&(this.prototype[e]=f);return null!=(g=d.included)?g.apply(this):void 0},_extend:function(b){var d,e,f,g;if(null!=b.ClassMethods)d=b.ClassMethods;else{if(null!=b.InstanceMethods)return;d=b}for(e in d)f=d[e],c.call(a.Mixable.MixableKeywords,e)<0&&null!=f&&(this[e]=f);return null!=(g=d.extended)?g.apply(this):void 0},include:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(j=this._includedMixins)?j.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),f=0,h=e.length;h>f;f++)d=e[f],c.call(this._includedMixins,d)>=0||(null!=d&&this._includedMixins.push(d),this._include(d),null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._include(a)));for(k=this._includedMixins,g=0,i=k.length;i>g;g++)d=k[g],null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._include(a));return this},extend:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(j=this._extendedMixins)?j.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),f=0,h=e.length;h>f;f++)d=e[f],c.call(this._extendedMixins,d)>=0||(null!=d&&this._extendedMixins.push(d),this._extend(d),null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._extend(a)));for(k=this._extendedMixins,g=0,i=k.length;i>g;g++)d=k[g],null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._extend(a));return this},"with":function(a,b){return null==b&&(b={}),c.call(this._includedMixins,a)>=0||c.call(this._extendedMixins,a)>=0?b:null},concern:function(){var a,c,d,e;for(c=1<=arguments.length?b.call(arguments,0):[],d=0,e=c.length;e>d;d++)a=c[d],this.include(a),this.extend(a);return this}},a.Mixins.DynamicAttributes={InstanceMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({getter:a})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({setter:a})},lazy:function(a,b){var c,d,e;null==b&&(b=null),"string"==typeof a&&null!=b&&(d=a,(a={})[d]=b),e=[];for(c in a)b=a[c],e.push(function(a){return function(b,c){var d,e;return(d={})[b]=function(){return this.attributes[b]=c()},(e={})[b]=function(a){return delete this.attributes[b],this.attributes[b]=a},a.getter(d),a.setter(e)}}(this)(c,b));return e},defineAttribute:function(a){var b,c,d,e,f;f=[];for(e in a)b=a[e],("getter"===e||"setter"===e)&&f.push(function(){var a;a=[];for(d in b)c=b[d],a.push(function(a){return function(b,c){var d;return d=Object.getOwnPropertyDescriptor(a.attributes,b)||{configurable:!0},"getter"===e?d.get=function(){return c.call(a)}:"setter"===e&&(d.set=function(b){return c.call(a,b)}),Object.defineProperty(a.attributes,b,d)}}(this)(d,c));return a}.call(this));return f}},ClassMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.getter(("function"==typeof a?a():void 0)||a)}})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.setter(("function"==typeof a?a():void 0)||a)}})},lazy:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.lazy(("function"==typeof a?a():void 0)||a)}})},extended:function(){return this.concern(a.Mixins.Interceptable)}}},a.Collection=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return g(c,b),_.extend(c,a.Mixable),c.prototype.format="json",c.prototype.initialize=function(b,d){return null==b&&(b=null),null==d&&(d={}),this.model=d.model||this.model||a.Model,this.parent=d.parent||this.parent,c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.model.name,["underscore","pluralize"])},c.prototype.url=function(){var b,c,d,e,f,g;return b=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||a.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+b+"/"+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),d.push(c)}return d},c}(Backbone.Deferred.Collection),a.Mixins.Collectable={InstanceMethods:{included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.id&&null!=this.constructor.collection().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.add(this)}})}},ClassMethods:{collection:function(){var b;return(null!=(b=this._collection)?b.klass:void 0)!==this&&(this._collection=new a.Collection(null,{model:this}),this._collection.klass=this),this._collection},get:function(a){return this.collection().get(a)||new this({id:a})},scope:function(b,c){var d,e,f,g;"string"!=typeof b&&(c=b),e=new a.Collection(this.collection().where(c.where),{model:this,parent:this}),g=c.where;for(d in g)f=g[d],this.collection().on("change:"+d,function(){return function(a,b){return b!==f&&e.contains(a)?e.remove(a):b!==f||e.contains(a)?void 0:e.add(a)}}(this)),this.collection().on("add",function(){return function(a){return a.get(d)!==f||e.contains(a)?void 0:e.add(a)}}(this)),this.collection().on("remove",function(){return function(a){return a.get(d)===f&&e.contains(a)?e.remove(a):void 0}}(this)),e.on("add",function(){return function(a){return a.get(d)!==f?a.set(d,f):void 0}}(this)),e.on("remove",function(){return function(a){return a.get(d)===f?a.set(d,void 0):void 0}}(this));return null!=b&&(this[b]=e),e},extended:function(){var a,c,d,e,f;for(c=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample","add","remove","set","at","push","pop","unshift","shift","slice","sort","pluck","where","findWhere","clone","create","fetch","reset","urlRoot","on","off","once","trigger","listenTo","stopListening","listenOnce"],f=[],d=0,e=c.length;e>d;d++)a=c[d],f.push(function(a){return function(c){return a[c]=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.collection()[c].apply(this.collection(),a)}}}(this)(a));return f}},Interactions:function(){return{ClassMethods:this["with"](a.Mixins.Storage,{extended:function(){return this.collection().on("add remove",function(a){return function(b){return null!=b.id?a.store():void 0}}(this))}})}}},a.Mixins.Relations={InstanceMethods:{belongsTo:function(a){var b,c,d,e,f;b=a.foreignKey,e=_(a).omit("foreignKey"),f=[];for(c in e)d=e[c],f.push(function(a){return function(b,c,d){var e,f;return b||(b=inflection.foreign_key(d.name)),e=a.get(b),f=a.get(c),a.unset(b,{silent:!0}),a.unset(c,{silent:!0}),a.getter(c,function(){return d.get(a.get(b))||new d({id:a.get(b)})}),a.setter(c,function(c){return null==c?a.unset(b):(null==d.get(c.id)&&d.create(c),a.set(b,c.id))}),a.on("change:"+b,function(){var e,f;return e=a.get(c),f=d.get(a.previous(b)),null!=e&&e!==f?(f&&a.stopListening(f),a.trigger("change:"+c,a,e),a.listenTo(e,"change:id",function(c,d){return a.set(b,d)})):void 0}),null!=f?a.set(c,f):null!=e?a.set(b,e):void 0}}(this)(b,c,d));return f},hasOne:function(a){var b,c,d,e,f;b=a.foreignKey,e=_(a).omit("foreignKey"),f=[];for(c in e)d=e[c],f.push(function(a){return function(b,c,d){var e;return b||(b=inflection.foreign_key(a.constructor.name)),e={},e[b]=a.id,a.getter(c,function(){return d.findWhere(e)||new d(e)}),a.setter(c,function(d){return a.attributes(c)[b]=void 0,d[b]=a.id})}}(this)(b,c,d));return f},hasMany:function(a){var b,c,d,e,f;b=a.foreignKey,e=_(a).omit("foreignKey"),f=[];for(c in e)d=e[c],f.push(function(a){return function(b,c,d){var e;return b||(b=inflection.foreign_key(a.constructor.name)),(e={})[b]=a.id,a.set(c,d.scope({where:e}))}}(this)(b,c,d));return f}},ClassMethods:{belongsTo:function(a){return this.before({initialize:function(){return this.belongsTo(("function"==typeof a?a():void 0)||a)}})},hasOne:function(a){return this.before({initialize:function(){return this.hasOne(("function"==typeof a?a():void 0)||a)}})},hasMany:function(a){return this.before({initialize:function(){return this.hasMany(("function"==typeof a?a():void 0)||a)}})},extended:function(){return this.concern(a.Mixins.DynamicAttributes),this.concern(a.Mixins.Collectable),this.concern(a.Mixins.Interceptable)}}},a.Mixins.Storage={InstanceMethods:{storage:function(){return this.constructor.storage()},indexRoot:function(){return this.constructor.indexRoot()},store:function(a){return this.constructor.store(this,a)},retrieve:function(a){return _.defaults(this.attributes,this.constructor.retrieve(this.id,a))},included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){return this.on("sync",this.store),this.retrieve(),this.store()}})}},ClassMethods:{storage:function(){return localStorage},toJSON:function(a){return("function"==typeof a.has?a.has("$el"):void 0)&&(a.get("$el").toJSON=function(){return this.clone().wrap("<div/>").parent().html()}),JSON.stringify(a)},indexRoot:function(){return inflection.transform(this.name,["underscore","pluralize"])},store:function(b,c){var d,e,f,g;if(null!=b&&null!=b.id)return d=null!=(g="function"==typeof this.indexRoot?this.indexRoot():void 0)?g:this.indexRoot,f=""+d+"/"+b.id,null!=c?(f+="/"+a.Utils.Hash(this.toJSON(c)),e=this.toJSON({instance:b,data:c})):e=this.toJSON(b),this.storage().setItem(f,e),f},retrieve:function(b,c){var d,e,f,g,h,i,j;if(e=null!=(j="function"==typeof this.indexRoot?this.indexRoot():void 0)?j:this.indexRoot,null==b){if(f=this.storage().getItem(a.Utils.Hash(e)),d=JSON.parse(f),null!=f)for(h=0,i=d.length;i>h;h++)b=d[h],this.retrieve(b);return d}return g=""+e+"/"+b,null!=c&&(g+="/"+c),f=this.storage().getItem(g),null!=f?JSON.parse(f):void 0}},Interactions:function(){return{InstanceMethods:this["with"](a.Mixins.Debug,{included:function(a){return function(){return a.after({initialize:function(){return console.log(this.toJSON(this.name)),this.after({store:function(){return this.log("Stored instances",this.constructor.pluck("id"))}})}})}}(this)}),ClassMethods:this["with"](a.Mixins.Collectable,{indexRoot:function(){var a;return null!=(a="function"==typeof this.urlRoot?this.urlRoot():void 0)?a:this.urlRoot},extended:function(){return this.after({store:function(){var a,b,c;return b=null!=(c="function"==typeof this.indexRoot?this.indexRoot():void 0)?c:this.indexRoot,a=this.toJSON(this.constructor.pluck("id")),this.constructor.storage().setItem(b,a)}})}})}}},a.Mixins.History={Interactions:function(){return{InstanceMethods:this["with"](a.Mixins.Storage,{diff:function(){var a,b,c,d,e;a={},a.apply=function(b){return function(c){var d,e,f,g;null==c&&(c=b);for(e in a){d=a[e];for(f in d)switch(g=d[f],f){case"create":c.set(e,g.value);break;case"update":c.set(e,g["new"]);break;case"delete":c.unset(e)}}return c}}(this),c=this.constructor.retrieve(this.id)||{},e=this.attributes;for(b in e)d=e[b],c[b]!==this.get(b)&&(a[b]=null!=c[b]?{update:{old:c[b],"new":this.get(b)}}:{create:{value:this.get(b)}});for(b in c)d=c[b],this.has(b)||(a[b]={"delete":{value:d}});return a},commit:function(){var a;return a=this.store(this.diff())},included:function(){return this.after({initialize:function(){return this.on("change",this.commit)}})}})}}},a.Mixins.Debug={InstanceMethods:{LOG_LEVELS:{ERROR:!0,WARNING:!0,INFO:!1},_excludedMethods:_.union(Object.keys(a.Mixins.Interceptable.InstanceMethods),["constructor","log","message","warn","error","info"]),message:function(){var a,c,d,e,f;for(d=1<=arguments.length?b.call(arguments,0):[],a=""+new Date+" - ",e=0,f=d.length;f>e;e++)c=d[e],a+="String"===c.constructor.name?c+" ":JSON.stringify(c)+" ";return a+="in "+this.constructor.name+"("+this.id+")"},error:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.ERROR?(a=this.message.apply(this,c),console.error(a)):void 0},warn:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.WARNING?(a=this.message.apply(this,c),console.warn(a)):void 0},log:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],a=this.message.apply(this,c),console.log(a)},info:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.INFO?(a=this.message.apply(this,c),console.log(a)):void 0},included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){var a,d,e,f,g,h,i;for(a=1<=arguments.length?b.call(arguments,0):[],this.info("Called function 'initialize' of "+this.constructor.name+" with arguments:",a),this.on("change",function(a){return function(b){return a.info("Change of attributes:",b.changedAttributes())}}(this)),d=function(){var a;a=[];for(e in this)f=this[e],f instanceof Function&&c.call(this._excludedMethods,e)<0&&a.push(e);return a}.call(this),i=[],g=0,h=d.length;h>g;g++)e=d[g],i.push(function(a){return function(c){return a.after({these:[c],"do":function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.info("Called function '"+c+"' of "+this.constructor.name+" with arguments:",a)}})}}(this)(e));return i}})}}},a.Model=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return g(c,b),_.extend(c,a.Mixable),c.concern(a.Mixins.Relations),c.prototype.format="json",c.prototype.initialize=function(a,b){var d;return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent||(null!=(d=this.collection)?d.parent:void 0),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.constructor.name,["underscore","pluralize"])},c.prototype.url=function(){var b,c,d,e,f,g,h;return b=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||a.config.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+b+"/"+e+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.save=function(a){return null==a&&(a={}),c.__super__.save.call(this,_.defaults(a,{dataType:this.format}))},c}(Backbone.Deferred.Model),a.Template=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return g(c,b),c.concern(a.Mixins.Collectable),c.prototype.urlRoot="assets",c.prototype.format="html",c.prototype.bind=function(a){return this.fetch({parse:!0}).then(function(b){return function(){var c;return c=$(b.get("$el")).clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(a.Model),a.View=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return g(c,b),_.extend(c,a.Mixable),c.prototype.initialize=function(b){return null==b&&(b={}),this.template.constructor===String&&(this.template=a.Template.get(this.template)),this.template.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.call(this,b)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),a.factory=function(b){return b._=a,b.Mixable=a.Mixable,b.Model=a.Model,b.Collection=a.Collection,b.View=a.View,b.Template=a.Template,b.Mixins=a.Mixins,b.Utils=a.Utils,b.Models=a.Models,b.Views=a.Views,b.config=a.config,b.configure=function(b){var c,d;null==b&&(b={});for(c in b)d=b[c],a.config[c]=d}},"object"==typeof exports?a.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(b){return a.factory(this.Tails=b),b}):a.factory(this.Tails={})}).call(this);