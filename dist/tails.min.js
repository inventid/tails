// Tails
// version: 0.0.1
// contributors: Joost Verdoorn
// license: MIT
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a=a.Mixins.Collectable={ClassMethods:{all:function(){var b;return(null!=(b=this._all)?b.klass:void 0)!==this&&(this._all=new a.Collection(null,{model:this}),this._all.klass=this),this._all},get:function(a){return this.all().get(a)||new this({id:a})},create:function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],all().create.apply(this,a)}},extended:function(){return this.extend(a.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.constructor.all().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.all().add(this)}})}},a.Mixins.DynamicProperties={ObjectMethods:{getter:function(a,b){return null==b&&(b=null),this.defineProperty("getter",a,b)},setter:function(a,b){return null==b&&(b=null),this.defineProperty("setter",a,b)},defineProperty:function(a,b,c){var d,e;if(null==c&&(c=null),"string"==typeof b){if("function"!=typeof c)throw new Error("Function expected but none was given.");d=b,b={},b[d]=c}e=[];for(d in b)c=b[d],e.push(function(b){return function(c,d){var e;return e=Object.getOwnPropertyDescriptor(b,c)||{configurable:!0},"getter"===a?e.get=function(){return d.call(b)}:"setter"===a&&(e.set=function(a){return d.call(b,a)}),Object.defineProperty(b,c,e)}}(this)(d,c));return e}}},a.Mixins.Interceptable={ClassMethods:{before:function(a,b){return null==b&&(b=null),this.intercept("before",a,b)},after:function(a,b){return null==b&&(b=null),this.intercept("after",a,b)},intercept:function(a,c,d){var e,f,g,h,i,j,k;if(null==d&&(d=null),_(c).isString()){if("function"!=(i=typeof d)&&"string"!==i)throw new Error("Function expected but none was given.");e=c,c={},c[e]=d}else if(_(c).isArray()){if("function"!=(j=typeof d)&&"string"!==j)throw new Error("Function expected but none was given.");for(f=c,c={},g=0,h=f.length;h>g;g++)e=f[g],c[e]=d}k=[];for(e in c)d=c[e],k.push(function(c){return function(d,e){var f,g,h,i,j,k,l,m,n;return c.prototype.hasOwnProperty(d)&&null==c.prototype[d].before&&null==c.prototype[d].after?(h=c.prototype[d],c.prototype[d]=function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],"before"===a&&(this[e]||e).apply(this,c),d=h.apply(this,c),"after"===a&&(this[e]||e).apply(this,c),d}):(g=((null!=(k=c.prototype[d])?k.klass:void 0)===c&&null!=(l=c.prototype[d])?l.before:void 0)||function(){},f=((null!=(m=c.prototype[d])?m.klass:void 0)===c&&null!=(n=c.prototype[d])?n.after:void 0)||function(){},"before"===a?(j=g,g=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],(this[e]||e).apply(this,a),j.apply(this,a)}):"after"===a&&(j=f,f=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],j.apply(this,a),(this[e]||e).apply(this,a)}),c.prototype.setter(d,function(a){return delete this[d],this[d]=function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],g.apply(this,c),d=a.apply(this,c),f.apply(this,c),d}}),i=c,c.prototype.getter(d,function(){var a;return a=function(){var a,c,e,h;return a=1<=arguments.length?b.call(arguments,0):[],g.apply(this,a),e=null!=(h=this.constructor.__super__)?h[d]:void 0,e.klass!==i&&(c=e.apply(this,a)),f.apply(this,a),c},a.before=g,a.after=f,a.klass=i,a}))}}(this)(e,d));return k}},extended:function(){return this.include(a.Mixins.DynamicProperties)}},a.Mixins.Relations={ClassMethods:{belongsTo:function(a){return this.addRelation("belongsTo",a)},hasOne:function(a){return this.addRelation("hasOne",a)},hasMany:function(a){return this.addRelation("hasMany",a)},addRelation:function(a,b){var c,d;return(null!=(d=this._relations)?d.klass:void 0)!==this&&(this._relations={klass:this}),(c=this._relations)[a]||(c[a]=[]),this._relations[a].push(b)}},extended:function(){return this.extend(a.Mixins.Collectable),this.after({initialize:function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(this._blacklistedAttributes||(this._blacklistedAttributes=[]),this instanceof Backbone.Model&&(null!=(k=this.constructor._relations)?k.klass:void 0)===this.constructor){if(null!=this.constructor._relations.belongsTo)for(l=this.constructor._relations.belongsTo,c=function(a){return function(b){var c,d,e,f,g;return e=b(),d=e.name.foreign_key(),f=e.name.underscore(),a._blacklistedAttributes.push(f),c=a.get(d),g=a.get(f),a.unset(d,{silent:!0}),a.unset(f,{silent:!0}),Object.defineProperty(a.attributes,d,{enumerable:!0,get:function(){var b;return null!=(b=a.get(f))?b.id:void 0},set:function(b){return a.set(f,e.get(b))}}),a.on("change:"+f,function(b,c){var g;return a.stopListening(a.previous(f)),null==c||c instanceof e?(a.trigger("change:"+d,a,c.id),a.listenTo(c,"change:id",function(b,c){return a.trigger("change:"+d,a,c)})):(g=c,c=e.get(g.id),c.set(g),c.synced=!0,void a.set(f,c))}),null!=g?a.set(f,g):null!=c?a.set(d,c):void 0}}(this),e=0,h=l.length;h>e;e++)b=l[e],c(b);if(null!=this.constructor._relations.hasOne)for(m=this.constructor._relations.hasOne,d=function(a){return function(b){var c,d,e,f;return d=b(),c=a.constructor.name.foreign_key(),e=d.name.underscore().camelize(!0),f={},f[c]=a.id,a.getter(e,function(){return d.all().findWhere(f)}),a.setter(e,function(a){return a.set(c,this.id)})}}(this),f=0,i=m.length;i>f;f++)b=m[f],d(b);if(null!=this.constructor._relations.hasMany){for(n=this.constructor._relations.hasMany,o=[],g=0,j=n.length;j>g;g++)b=n[g],o.push(function(b){return function(c){var d,e,f,g;return f=c(),e=b.constructor.name.foreign_key(),g=f.name.pluralize().underscore(),b._blacklistedAttributes.push(g),d=new a.Collection(null,{model:f,parent:b}),b.set(g,d),d.add(f.all().find(function(a){return a[g]===b.id})),f.all().on("change:"+e,function(a,c){return c!==b.id&&d.contains(a)?d.remove(a):c!==b.id||d.contains(a)?void 0:d.add(a)}),f.all().on("add",function(a){return a.get(e)!==b.id||d.contains(a)?void 0:d.add(a)}),f.all().on("remove",function(a){return a.get(e)===b.id&&d.contains(a)?d.remove(a):void 0}),d.on("add",function(a){return a.get(e)!==b.id?a.set(e,b.id):void 0}),d.on("remove",function(a){return a.get(e)===b.id?a.set(e,null):void 0})}}(this)(b));return o}}}})}},a.Mixable={include:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._includedMixins)?i.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._includedMixins,d)<0){j=_.extend({},d.InstanceMethods,d.ObjectMethods);for(a in j)f=j[a],this.prototype[a]=f;this._includedMixins.push(d),null!=(k=d.included)&&k.apply(this)}return this},extend:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._extendedMixins)?i.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._extendedMixins,d)<0){j=_.extend({},d.ClassMethods,d.ObjectMethods);for(a in j)f=j[a],this[a]=f;this._extendedMixins.push(d),null!=(k=d.extended)&&k.apply(this)}return this},concern:function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.extend.apply(this,a),this.include.apply(this,a),this}},a.Model=function(c){function d(){return d.__super__.constructor.apply(this,arguments)}return e(d,c),_.extend(d,a.Mixable),d.concern(a.Mixins.DynamicProperties),d.prototype.syncing=!1,d.prototype.dataType="json",d.prototype.initialize=function(a,b){return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent,this.synced=b.synced||!1,this.on("change",function(a){return function(b){var c,d,e,f;a.synced=!1,e=b.changed,f=[];for(c in e)d=e[c],a.hasOwnProperty(c.camelize(!0))||f.push(function(b){return a.getter(b.camelize(!0),function(){return a.get(b)}),a.setter(b.camelize(!0),function(c){return a.set(b,c)})}(c));return f}}(this)),this.on("sync",function(){return this.synced=!0}),d.__super__.initialize.apply(this,arguments)},d.prototype.urlRoot=function(){return"/"+this.constructor.name.pluralize().underscore()},d.prototype.url=function(){var b,c,d,e,f,g,h;return b=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||a.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+b+e+d+c},d.prototype.fetch=function(a){var c,e,f;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(_.defaults(a,{dataType:this.format}),e=d.__super__.fetch.call(this,a),this.synced=!1,this.syncing=!0,c=Q.defer(),f=function(a){return function(){var d;return d=1<=arguments.length?b.call(arguments,0):[],a.syncing=!1,c.resolve.apply(c,d)}}(this),e.then(function(a){return function(){var c;return c=1<=arguments.length?b.call(arguments,0):[],a.synced?f.apply(a,c):a.once("sync",function(){return f.apply(this,c)})}}(this)),e.fail(function(){return function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],c.reject.apply(c,a)}}(this)),this._fetchPromise=c.promise)},d.prototype.save=function(a){var c,e,f;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(_.defaults(a,{dataType:this.format}),e=d.__super__.save.call(this,a),this.synced=!1,this.syncing=!0,c=Q.defer(),f=function(a){return function(){var d;return d=1<=arguments.length?b.call(arguments,0):[],a.syncing=!1,c.resolve.apply(c,d)}}(this),e.then(function(a){return function(){var c;return c=1<=arguments.length?b.call(arguments,0):[],a.synced?f.apply(a,c):a.once("sync",function(){return f.apply(this,c)})}}(this)),e.fail(function(){return function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],c.reject.apply(c,a)}}(this)),this._fetchPromise=c.promise)},d.prototype.toJSON=function(){return _.omit(this.attributes,this._blacklistedAttributes)},d}(Backbone.Deferred.Model),a.Collection=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.model=null,c.prototype.syncing=!1,c.prototype.dataType="json",c.prototype.initialize=function(b,d){return null==b&&(b=null),null==d&&(d={}),this.model=d.model||this.model||a.Models[this.constructor.name.singularize()]||a.Model,this.parent=d.parent||this.parent,this.synced=d.synced||!1,this.on("sync",function(){return this.synced=!0}),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return"/"+this.model.name.pluralize().underscore()},c.prototype.url=function(){var b,c,d,e,f,g;return b=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||a.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+b+d+c},c.prototype.fetch=function(a){var b,d,e;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(this.syncing=!0,this.synced=!1,_.defaults(a,{dataType:this.format}),d=c.__super__.fetch.call(this,a),b=Q.defer(),e=function(a){return function(){return a.syncing=!1,b.resolve(a)}}(this),d.then(function(a){return function(){return a.synced?e():a.once("sync",function(){return e()})}}(this)),this._fetchPromise=b.promise)},c.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),c.synced=!0,d.push(c)}return d},c}(Backbone.Deferred.Collection),a.View=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.initialize=function(a){var b;return null==a&&(a={}),null!=(b=this.template)&&b.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.apply(this,arguments)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),a.Template=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.concern(a.Mixins.Collectable),c.prototype.urlRoot="/assets",c.prototype.format="html",c.prototype.initialize=function(a,b){return null==a&&(a={}),null==b&&(b={}),c.__super__.initialize.apply(this,arguments)},c.prototype.bind=function(a){return this.fetch().then(function(b){return function(){var c;return c=b.$el.clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(a.Model)}).call(this);