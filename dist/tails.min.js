// Tails
// version: 0.0.2
// contributors: Joost Verdoorn,Steffan Sluis
// license: MIT
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a={Mixins:{},Utils:{},Associations:{},Models:{},Views:{},config:{url:"http://localhost"}},a.Utils.Hash=function(a){var b,c,d,e,f;if(c=0,0===a.length)return c;for(d=e=0,f=a.length;f>=0?f>e:e>f;d=f>=0?++e:--e)b=a.charCodeAt(d),c=(c<<5)-c+b,c&=c;return c},a.Mixins.Interceptable={InstanceMethods:{before:function(a){return this.intercept({before:a})},after:function(a){return this.intercept({after:a})},intercept:function(a){var c,d,e,f,g,h,i,j,k,l,m,n;h=this.constructor,n=[];for(i in a)if(e=a[i],"before"===i||"after"===i){if(null!=e.these)for(m=e.these,k=0,l=m.length;l>k;k++){if(g=m[k],"function"==typeof g)for(f in this)if(j=this[f],g===j){g=f;break}e[g]=e["do"]}e=_(e).omit("these","do"),n.push(function(){var a;a=[];for(g in e)d=e[g],_(d).isArray()||(d=[d]),a.push(function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)c=d[a],f.push(function(a){return function(c,d){var e,f,g,j,k,l,m,n;return(a.hasOwnProperty(c)||h.prototype.hasOwnProperty(c))&&null==a[c].before&&null==a[c].after?(g=a[c],a[c]=function(){var a,c;return a=1<=arguments.length?b.call(arguments,0):[],"before"===i&&(this[d]||d).apply(this,a),c=g.apply(this,a),"after"===i&&(this[d]||d).apply(this,a),c}):(f=(null!=(k=a[c])?k.klass:void 0)===h&&null!=(l=a[c])?l.before:void 0,e=(null!=(m=a[c])?m.klass:void 0)===h&&null!=(n=a[c])?n.after:void 0,"before"===i?(j=f,f=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],null!=j&&j.apply(this,a),(this[d]||d).apply(this,a)}):"after"===i&&(j=e,e=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],(this[d]||d).apply(this,a),null!=j?j.apply(this,a):void 0}),Object.defineProperty(a,c,{configurable:!0,set:function(a){return Object.defineProperty(this,c,{writable:!0,value:function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,c),d=a.apply(this,c),null!=e&&e.apply(this,c),d}})},get:function(){var a;return a=function(){var a,d,g,i;return a=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,a),g=null!=(i=this.constructor.__super__)?i[c]:void 0,(null!=g?g.klass:void 0)!==h&&(d=null!=g?g.apply(this,a):void 0),null!=e&&e.apply(this,a),d},a.before=f,a.after=e,a.klass=h,a}}))}}(this)(g,c));return f}.call(this));return a}.call(this))}return n}},ClassMethods:{before:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.before(a.call(this))}}):this.prototype.before(a)},after:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.after(a.call(this))}}):this.prototype.after(a)}}},a.Mixins.Debug={InstanceMethods:{LOG_LEVELS:{ERROR:!0,WARNING:!0,INFO:!1},_excludedMethods:_.union(Object.keys(a.Mixins.Interceptable.InstanceMethods),["constructor","log","message","warn","error","info"]),debug:function(){return this.LOG_LEVELS.INFO=!0},message:function(){var a,c,d,e,f;for(d=1<=arguments.length?b.call(arguments,0):[],a=""+new Date+" - ",e=0,f=d.length;f>e;e++)c=d[e],a+="String"===c.constructor.name?c+" ":JSON.stringify(c)+" ";return a+="in "+this.constructor.name+"("+this.id+")"},error:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.ERROR?(a=this.message.apply(this,c),console.error(a)):void 0},warn:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.WARNING?(a=this.message.apply(this,c),console.warn(a)):void 0},log:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],a=this.message.apply(this,c),console.log(a)},info:function(){var a,c;return c=1<=arguments.length?b.call(arguments,0):[],this.LOG_LEVELS.INFO?(a=this.message.apply(this,c),console.log(a)):void 0},included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){var a,d,e,f,g,h,i;for(a=1<=arguments.length?b.call(arguments,0):[],this.info("Called function 'initialize' of "+this.constructor.name+" with arguments:",a),this.on("change",function(a){return function(b){return a.info("Change of attributes:",b.changedAttributes())}}(this)),d=function(){var a;a=[];for(e in this)f=this[e],f instanceof Function&&c.call(this._excludedMethods,e)<0&&a.push(e);return a}.call(this),i=[],g=0,h=d.length;h>g;g++)e=d[g],i.push(function(a){return function(c){return a.after({these:[c],"do":function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.info("Called function '"+c+"' of "+this.constructor.name+" with arguments:",a)}})}}(this)(e));return i}})}}},a.Mixable={MixableKeywords:["included","extended","constructor","Interactions","InstanceMethods","ClassMethods"],_include:function(b){var d,e,f,g;if(null!=b.InstanceMethods)d=b.InstanceMethods;else{if(null!=b.ClassMethods)return;d=b}for(e in d)f=d[e],c.call(a.Mixable.MixableKeywords,e)<0&&null!=f&&(this.prototype[e]=f);return null!=(g=d.included)?g.apply(this):void 0},_extend:function(b){var d,e,f,g;if(null!=b.ClassMethods)d=b.ClassMethods;else{if(null!=b.InstanceMethods)return;d=b}for(e in d)f=d[e],c.call(a.Mixable.MixableKeywords,e)<0&&null!=f&&(this[e]=f);return null!=(g=d.extended)?g.apply(this):void 0},include:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(j=this._includedMixins)?j.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),f=0,h=e.length;h>f;f++)d=e[f],c.call(this._includedMixins,d)>=0||(null!=d&&this._includedMixins.push(d),this._include(d),null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._include(a)));for(k=this._includedMixins,g=0,i=k.length;i>g;g++)d=k[g],null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._include(a));return this},extend:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(j=this._extendedMixins)?j.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),f=0,h=e.length;h>f;f++)d=e[f],c.call(this._extendedMixins,d)>=0||(null!=d&&this._extendedMixins.push(d),this._extend(d),null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._extend(a)));for(k=this._extendedMixins,g=0,i=k.length;i>g;g++)d=k[g],null!=d.Interactions&&(a=d.Interactions.apply(this),null!=a&&this._extend(a));return this},"with":function(a,b){return null==b&&(b={}),c.call(this._includedMixins,a)>=0||c.call(this._extendedMixins,a)>=0?b:null},concern:function(){var a,c,d,e;for(c=1<=arguments.length?b.call(arguments,0):[],d=0,e=c.length;e>d;d++)a=c[d],this.include(a),this.extend(a);return this}},a.Mixins.DynamicAttributes={InstanceMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({getter:a})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({setter:a})},lazy:function(a,b){var c,d,e;null==b&&(b=null),"string"==typeof a&&null!=b&&(d=a,(a={})[d]=b),e=[];for(c in a)b=a[c],e.push(function(a){return function(b,c){return a.getter(b,function(){return a.attributes[b]=(a[c]||c).call(a)}),a.setter(b,function(c){return delete a.attributes[b],a.attributes[b]=c})}}(this)(c,b));return e},defineAttribute:function(a){var b,c,d,e,f;f=[];for(e in a)b=a[e],("getter"===e||"setter"===e)&&f.push(function(){var a;a=[];for(d in b)c=b[d],a.push(function(a){return function(b,c){var d;return d=Object.getOwnPropertyDescriptor(a.attributes,b)||{configurable:!0},delete a.attributes[b],delete d.value,delete d.writable,"getter"===e?d.get=function(){return(a[c]||c).call(a)}:"setter"===e&&(d.set=function(b){var d;return d=(a[c]||c).call(a,b)}),Object.defineProperty(a.attributes,b,d)}}(this)(d,c));return a}.call(this));return f}},ClassMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.getter(a)}})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.setter(a)}})},lazy:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.lazy(a)}})},extended:function(){return this.concern(a.Mixins.Interceptable)}}},a.Collection=function(b){function d(b,c){null==b&&(b=[]),null==c&&(c={}),this.model=c.model||this.model||a.Model,this.parent=c.parent||this.parent,d.__super__.constructor.apply(this,arguments)}return e(d,b),_.extend(d,a.Mixable),d.prototype.format="json",d.prototype.urlRoot=function(){return inflection.transform(this.model.name,["underscore","pluralize"])},d.prototype.url=function(){var b,c,d,e,f,g;return b=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||a.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+b+"/"+d+c},d.prototype.fetch=function(a){return null==a&&(a={}),d.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},d.prototype.filter=function(b){return new a.Collection.Filtered(this,{filter:b})},d.prototype.where=function(b,e){var f,g,h,i,j;return null!=e?d.__super__.where.call(this,b,e):"object"==typeof b?(h=function(a){var c,d;for(c in b)if(d=b[c],a.get(c)!==d)return!1;return!0},f=function(a){var c,d,e;e=[];for(c in b)d=b[c],e.push(a.set(c,d));return e},g=function(a){var c,d,e;e=[];for(c in b)d=b[c],e.push(a.unset(c));return e},new a.Collection.Filtered(this,{filter:h,assimilate:f,distantiate:g})):"string"==typeof b?(i=b,j={is:function(a){return function(b){var c,d,e,f;return(c={})[i]=b,(d=(e=(f=a._where||(a._where={}))[i]||(f[i]={})).is||(e.is={}))[b]||(d[b]=a.where(c))}}(this),"in":function(a){return function(b){return a.filter(function(a){var d;return d=a.get(i),c.call(b,d)>=0})}}(this),atLeast:function(a){return function(b){return a.filter(function(a){return a.get(i)>=b})}}(this),atMost:function(a){return function(b){return a.filter(function(a){return a.get(i)<=b})}}(this),greaterThan:function(a){return function(b){return a.filter(function(a){return a.get(i)>b})}}(this),lessThan:function(a){return function(b){return a.filter(function(a){return a.get(i)<b})}}(this)}):void 0},d.prototype.pluck=function(b){return new a.Collection.Plucked(this,{attribute:b})},d.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),d.push(c)}return d},d}(Backbone.Deferred.Collection),a.Collection.Plucked=function(a){function d(a,b){null==b&&(b={}),this.collection=a,this.attribute=b.attribute,this.length=0,d.__super__.constructor.call(this,[],b),this.collection.each(function(a){return function(b){return a.trigger("add",b.get(a.attribute))}}(this)),this.listenTo(a,"change:"+this.attribute,function(a){return function(b){var c,d;return d=b.get(a.attribute),c=b.previous(a.attribute),null!=c&&a.trigger("remove",c),null!=d?a.trigger("add",d):void 0}}(this)),this.listenTo(a,"add",function(a){return function(b){var c;return c=b.get(a.attribute),null!=c&&a.trigger("add",c),a.length++}}(this)),this.listenTo(a,"remove",function(a){return function(b){var c;return c=b.get(a.attribute),null!=c&&a.trigger("remove",c),a.length--}}(this))}return e(d,a),d.prototype.contains=function(a){return c.call(this.toArray(),a)>=0},d.prototype.include=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.contains.apply(this,a)},d.prototype.each=function(a){return this.collection.each(function(b){return function(c){return a(c.get(b.attribute))}}(this))},d.prototype.forEach=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.each.apply(this,a)},d.prototype.toArray=function(){var a;return function(){var b,c,d,e;for(d=this.collection.toArray(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.get(this.attribute));return e}.call(this)},d}(a.Collection),a.Collection.Filtered=function(a){function b(a,c){null==c&&(c={}),this.collection=a,this.model=this.collection.model,this.filter=c.filter,this.assimilate=c.assimilate,this.distantiate=c.distantiate,b.__super__.constructor.call(this,[],c),this.collection.each(function(a){return function(b){return a.filter(b)?a.add(b):void 0}}(this)),this.listenTo(this.collection,"add",function(a){return function(b){return a.filter(b)?a.add(b):void 0}}(this)),this.listenTo(this.collection,"remove",function(a){return function(b){return a.remove(b)}}(this)),this.listenTo(this.collection,"change",function(a){return function(b){return a.filter(b)?a.add(b):a.remove(b)}}(this)),this.on("add",function(a){return function(b){if(!a.filter(b)){if(null==a.assimilate)throw a.remove(b),Error("Cannot assimilate model.");return a.assimilate(b),a.collection.add(b)}}}(this)),this.on("remove",function(a){return function(b){if(a.collection.contains(b)&&a.filter(b)){if(null==a.distantiate)throw a.add(b),Error("Cannot distantiate model.");return a.distantiate(b)}}}(this))}return e(b,a),b}(a.Collection),a.Collection.Multi=function(a){function b(a,c){var d,e,f;for(null==a&&(a=[]),null==c&&(c={}),this.collections=[],this.modelCounts={},b.__super__.constructor.call(this,[],c),e=0,f=a.length;f>e;e++)d=a[e],this.addCollection(d)}return e(b,a),b.prototype.increment=function(a){var b,c;return(b=this.modelCounts)[c=a.cid]||(b[c]=0),++this.modelCounts[a.cid]},b.prototype.decrement=function(a){var b,c;return(b=this.modelCounts)[c=a.cid]||(b[c]=0),--this.modelCounts[a.cid]},b.prototype.addCollection=function(a){return a instanceof Backbone.Collection?(this.model||(this.model=a.model),this.collections.push(a),a.each(function(a){return function(b){return a.increment(b)}}(this)),this.listenTo(a,"add",this.increment),this.listenTo(a,"remove",this.decrement),this.trigger("addCollection",a)):void 0},b.prototype.removeCollection=function(a){var b;if(a instanceof Backbone.Collection&&(b=this.collections.indexOf(a),b>=0))return this.collections=this.collections.slice(0,b).concat(this.collections.slice(b+1,this.collections.length)),a.each(function(a){return function(b){return a.decrement(b)}}(this)),this.stopListening(a),this.trigger("removeCollection",a)},b}(a.Collection),a.Collection.Union=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.increment=function(a){return 1===b.__super__.increment.apply(this,arguments)?this.add(a):void 0},b.prototype.decrement=function(a){return 0===b.__super__.decrement.apply(this,arguments)?this.remove(a):void 0},b}(a.Collection.Multi),a.Mixins.Collectable={InstanceMethods:{included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.id&&null!=this.constructor.all().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.all().add(this)}})}},ClassMethods:{all:function(){var b;return(null!=(b=this._all)?b.klass:void 0)!==this&&(this._all=new a.Collection(null,{model:this}),this._all.klass=this),this._all},get:function(a){return this.all().get(a)||new this({id:a})},scope:function(a,b){return this[a]=this.all().where(b.where)}},Interactions:function(){return{ClassMethods:this["with"](a.Mixins.Storage,{extended:function(){return this.all().on("add remove",function(a){return function(b){return null!=b.id?a.store():void 0}}(this))}})}}},a.Associations.Relation=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.concern(a.Mixins.DynamicAttributes),c.concern(a.Mixins.Collectable),c.prototype.initialize=function(){},c}(Backbone.Model),a.Associations.BelongsToRelation=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.initialize=function(){var a,c,d,e;return a=this.get("association"),e=a.get("to"),c=this.get("foreignKey"),d=this.get("owner"),this.getter({target:function(){return e.all().get(d.get(c))}}),this.setter({target:function(a){return null==a?void this.set(c,null):(null==e.all().get(a.id)&&e.all().create(a),d.set(c,a.id))}}),b.__super__.initialize.apply(this,arguments)},b}(a.Associations.Relation),a.Associations.HasOneRelation=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.initialize=function(){var a,c,d,e,f,g;return d=this.get("owner"),a=this.get("association"),g=a.get("to"),c=this.get("foreignKey"),f=this.get("through"),e=this.get("source"),null==f?(this.getter({target:function(){return function(){return g.all().where(c).is(d.id).first()}}(this)}),this.setter({target:function(){return function(a){var b;return null!=(b=g.all().where(c).is(d.id).first())&&b.unset(c),a.set(c,d.id)}}(this)})):(this.getter({target:function(){return function(){return d.get(f).get(e)}}(this)}),this.setter({target:function(){return function(a){return d.get(f).set(e,a)}}(this)})),b.__super__.initialize.apply(this,arguments)},b}(a.Associations.Relation),a.Associations.HasManyRelation=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.prototype.initialize=function(){var b,c,d,e,f,g,h,i,j;return b=this.get("association"),j=b.get("to"),e=this.get("owner"),d=this.get("name"),c=this.get("foreignKey"),h=this.get("through"),f=this.get("source"),null==h?this.lazy({target:function(){return function(){return j.all().where(c).is(e.id)}}(this)}):(i=e.constructor.associations().findWhere({name:h}),"hasMany"!==i.get("type")?this.getter({target:function(){return function(){return e.get(h).get(f||d)}}(this)}):(g=f&&i.get("to").associations().findWhere({name:f})||i.get("to").associations().findWhere({name:d,type:"hasMany"})||i.get("to").associations().findWhere({name:inflection.singularize(d)}),"hasMany"===g.get("type")?(f=g.get("name"),this.lazy({target:function(){var b;return b=new a.Collection.Union,e.get(h).each(function(){return function(a){return b.addCollection(a.get(f))}}(this)),e.get(h).on("add",function(){return function(a){return b.addCollection(a.get(f))}}(this)),e.get(h).on("remove",function(){return function(a){return b.removeCollection(a.get(f))}}(this)),b}})):(f=g.get("name"),this.lazy({target:function(){return e.get(h).pluck(f)}}))))},c}(a.Associations.Relation),a.Associations.Association=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.concern(a.Mixins.Debug),c.concern(a.Mixins.DynamicAttributes),c.concern(a.Mixins.Collectable),c.prototype.relations=function(){return null==this._relations&&(this._relations=new a.Collection([],{model:a.Associations.Relation})),this._relations},c.prototype.apply=function(b){var c,d,e;switch(c={association:this,from:this.get("from"),to:this.get("to"),name:this.get("name"),owner:b},this.get("type")){case"belongsTo":d=b.get(c.name),e=new a.Associations.BelongsToRelation(_.extend(c,{foreignKey:this.get("foreignKey")||inflection.foreign_key(c.to.name)})),null!=d&&e.set("target",d);break;case"hasOne":d=b.get(c.name),e=new a.Associations.HasOneRelation(_.extend(c,{foreignKey:this.get("foreignKey")||inflection.foreign_key(c.from.name),through:this.get("through"),source:this.get("source")||this.get("name")})),null!=d&&e.set("target",d);break;case"hasMany":e=new a.Associations.HasManyRelation(_.extend(c,{foreignKey:this.get("foreignKey")||inflection.foreign_key(c.from.name),through:this.get("through"),source:this.get("source")||this.get("name")}))}return this.relations().add(e),b.relations().add(e),b.getter(c.name,function(){return e.get("target")}),b.setter(c.name,function(a){return e.set("target",a)})},c}(Backbone.Model),a.Mixins.Associable={InstanceMethods:{relations:function(){return null==this._relations&&(this._relations=new a.Collection([],{model:a.Associations.Relation})),this._relations}},ClassMethods:{belongsTo:function(a){return this.associate("belongsTo",a)},hasOne:function(a){return this.associate("hasOne",a)},hasMany:function(a){return this.associate("hasMany",a)},associate:function(b,c){var d,e,f,g;return f=_(c).keys()[0],g=c[f],e={type:b,from:this,name:f,foreignKey:c.foreignKey,through:c.through,source:c.source},d=new a.Associations.Association(e),g.prototype instanceof Backbone.Model?d.set({to:g}):d.getter({to:g})},associations:function(){var b;return(null!=(b=this._associations)?b.klass=this:void 0)||(this._associations=a.Associations.Association.all().where({from:this}),this._associations.klass=this),this._associations},extended:function(){return this.concern(a.Mixins.DynamicAttributes),this.concern(a.Mixins.Collectable),this.concern(a.Mixins.Interceptable),this.before({initialize:function(){return this.constructor.associations().each(function(a){return function(b){return b.apply(a)}}(this))}})}}},a.Mixins.Storage={InstanceMethods:{storage:function(){return this.constructor.storage()},indexRoot:function(){return this.constructor.indexRoot()},store:function(a){return this.constructor.store(this,a)},retrieve:function(a){return _.defaults(this.attributes,this.constructor.retrieve(this.id,a))},included:function(){return this.concern(a.Mixins.Interceptable),this.after({initialize:function(){return this.on("sync",this.store),this.retrieve(),this.store()}})}},ClassMethods:{storage:function(){return localStorage},toJSON:function(a){return("function"==typeof a.has?a.has("$el"):void 0)&&(a.get("$el").toJSON=function(){return this.clone().wrap("<div/>").parent().html()}),JSON.stringify(a)},indexRoot:function(){return inflection.transform(this.name,["underscore","pluralize"])},store:function(b,c){var d,e,f,g;if(null!=b&&null!=b.id)return d=null!=(g="function"==typeof this.indexRoot?this.indexRoot():void 0)?g:this.indexRoot,f=""+d+"/"+b.id,null!=c?(f+="/"+a.Utils.Hash(this.toJSON(c)),e=this.toJSON({instance:b,data:c})):e=this.toJSON(b),this.storage().setItem(f,e),f},retrieve:function(b,c){var d,e,f,g,h,i,j;if(e=null!=(j="function"==typeof this.indexRoot?this.indexRoot():void 0)?j:this.indexRoot,null==b){if(f=this.storage().getItem(a.Utils.Hash(e)),d=JSON.parse(f),null!=f)for(h=0,i=d.length;i>h;h++)b=d[h],this.retrieve(b);return d}return g=""+e+"/"+b,null!=c&&(g+="/"+c),f=this.storage().getItem(g),null!=f?JSON.parse(f):void 0}},Interactions:function(){return{InstanceMethods:this["with"](a.Mixins.Debug,{included:function(a){return function(){return a.after({initialize:function(){return console.log(this.toJSON(this.name)),this.after({store:function(){return this.log("Stored instances",this.constructor.all().pluck("id"))}})}})}}(this)}),ClassMethods:this["with"](a.Mixins.Collectable,{indexRoot:function(){var a;return null!=(a="function"==typeof this.urlRoot?this.urlRoot():void 0)?a:this.urlRoot},extended:function(){return this.after({store:function(){var a,b,c;return b=null!=(c="function"==typeof this.indexRoot?this.indexRoot():void 0)?c:this.indexRoot,a=this.toJSON(this.constructor.all().pluck("id")),this.constructor.storage().setItem(b,a)}})}})}}},a.Mixins.History={Interactions:function(){return{InstanceMethods:this["with"](a.Mixins.Storage,{diff:function(){var a,b,c,d,e;a={},a.apply=function(b){return function(c){var d,e,f,g;null==c&&(c=b);for(e in a){d=a[e];for(f in d)switch(g=d[f],f){case"create":c.set(e,g.value);break;case"update":c.set(e,g["new"]);break;case"delete":c.unset(e)}}return c}}(this),c=this.constructor.retrieve(this.id)||{},e=this.attributes;for(b in e)d=e[b],c[b]!==this.get(b)&&(a[b]=null!=c[b]?{update:{old:c[b],"new":this.get(b)}}:{create:{value:this.get(b)}});for(b in c)d=c[b],this.has(b)||(a[b]={"delete":{value:d}});return a},commit:function(){var a;return a=this.store(this.diff())},included:function(){return this.after({initialize:function(){return this.on("change",this.commit)}})}})}}},a.Model=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.concern(a.Mixins.Associable),c.prototype.format="json",c.prototype.initialize=function(a,b){var d;return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent||(null!=(d=this.collection)?d.parent:void 0),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.constructor.name,["underscore","pluralize"])},c.prototype.url=function(){var b,c,d,e,f,g,h;return b=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||a.config.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+b+"/"+e+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.save=function(a){return null==a&&(a={}),c.__super__.save.call(this,_.defaults(a,{dataType:this.format}))},c}(Backbone.Deferred.Model),a.Template=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.concern(a.Mixins.Collectable),c.prototype.urlRoot="assets",c.prototype.format="html",c.prototype.bind=function(a){return this.fetch({parse:!0}).then(function(b){return function(){var c;return c=$(b.get("$el")).clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(a.Model),a.View=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.initialize=function(b){return null==b&&(b={}),this.template.constructor===String&&(this.template=a.Template.get(this.template)),this.template.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.call(this,b)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),a.factory=function(b){return b._=a,b.Mixable=a.Mixable,b.Model=a.Model,b.Collection=a.Collection,b.View=a.View,b.Template=a.Template,b.Mixins=a.Mixins,b.Utils=a.Utils,b.Association=a.Association,b.Associations=a.Associations,b.Models=a.Models,b.Views=a.Views,b.config=a.config,b.configure=function(b){var c,d;null==b&&(b={});for(c in b)d=b[c],a.config[c]=d}},"object"==typeof exports?a.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(b){return a.factory(this.Tails=b),b}):a.factory(this.Tails={})}).call(this);