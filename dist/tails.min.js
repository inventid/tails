// Tails
// version: 0.0.1
// contributors: Joost Verdoorn
// license: MIT
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a={Mixins:{},Models:{},Views:{},config:{}},a.Mixins.Interceptable={InstanceMethods:{before:function(a){return this.intercept({before:a})},after:function(a){return this.intercept({after:a})},intercept:function(a){var c,d,e,f,g,h,i,j,k,l,m,n;h=this.constructor||this,n=[];for(i in a)if(e=a[i],"before"===i||"after"===i){if(null!=e.these)for(m=e.these,k=0,l=m.length;l>k;k++){if(g=m[k],"function"==typeof g)for(f in this)if(j=this[f],g===j){g=f;break}e[g]=e["do"]}e=_(e).omit("these","do"),n.push(function(){var a;a=[];for(g in e)d=e[g],_(d).isArray()||(d=[d]),a.push(function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)c=d[a],f.push(function(a){return function(c,d){var e,f,g,j,k,l,m,n;return(a.hasOwnProperty(c)||h.prototype.hasOwnProperty(c))&&null==a[c].before&&null==a[c].after?(g=a[c],a[c]=function(){var a,c;return a=1<=arguments.length?b.call(arguments,0):[],"before"===i&&(this[d]||d).apply(this,a),c=g.apply(this,a),"after"===i&&(this[d]||d).apply(this,a),c}):(f=(null!=(k=a[c])?k.klass:void 0)===h&&null!=(l=a[c])?l.before:void 0,e=(null!=(m=a[c])?m.klass:void 0)===h&&null!=(n=a[c])?n.after:void 0,"before"===i?(j=f,f=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],(this[d]||d).apply(this,a),null!=j?j.apply(this,a):void 0}):"after"===i&&(j=e,e=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],null!=j&&j.apply(this,a),(this[d]||d).apply(this,a)}),Object.defineProperty(a,c,{configurable:!0,set:function(a){return delete this[c],this[c]=function(){var c,d;return c=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,c),d=a.apply(this,c),null!=e&&e.apply(this,c),d}},get:function(){var a;return a=function(){var a,d,g,i;return a=1<=arguments.length?b.call(arguments,0):[],null!=f&&f.apply(this,a),g=null!=(i=this.constructor.__super__)?i[c]:void 0,(null!=g?g.klass:void 0)!==h&&(d=null!=g?g.apply(this,a):void 0),null!=e&&e.apply(this,a),d},a.before=f,a.after=e,a.klass=h,a}}))}}(this)(g,c));return f}.call(this));return a}.call(this))}return n}},ClassMethods:{before:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.before(a.call(this))}}):this.prototype.before(a)},after:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.after(a.call(this))}}):this.prototype.after(a)}}},a.Mixins.DynamicProperties={InstanceMethods:{getter:function(a){return this.defineProperty({getter:a})},setter:function(a){return this.defineProperty({setter:a})},defineProperty:function(a){var b,c,d,e,f;f=[];for(e in a)b=a[e],("getter"===e||"setter"===e)&&f.push(function(){var a;a=[];for(d in b)c=b[d],a.push(function(a){return function(b,c){var d;return d=Object.getOwnPropertyDescriptor(a,b)||{configurable:!0},"getter"===e?d.get=function(){return c.call(a)}:"setter"===e&&(d.set=function(b){return c.call(a,b)}),Object.defineProperty(a,b,d)}}(this)(d,c));return a}.call(this));return f}},ClassMethods:{getter:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.getter(a.call(this))}}):this.prototype.getter(a)},setter:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.setter(a.call(this))}}):this.prototype.setter(a)}},extended:function(){return this.concern(a.Mixins.Interceptable)}},a.Mixins.Collectable={ClassMethods:{all:function(){var b;return(null!=(b=this._all)?b.klass:void 0)!==this&&(this._all=new a.Collection(null,{model:this}),this._all.klass=this),this._all},get:function(a){return this.all().get(a)||new this({id:a})},create:function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],all().create.apply(this,a)}},extended:function(){return this.extend(a.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.constructor.all().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.all().add(this)}})}},a.Mixins.Relations={InstanceMethods:{belongsTo:function(a){var b,c,d;d=[];for(b in a)c=a[b],d.push(function(a){return function(b,c){var d,e,f;return e=_(c.name).underscored()+"_id",d=a.get(e),f=a.get(b),a.unset(e,{silent:!0}),a.unset(b,{silent:!0}),a.getter(b,function(){return c.get(a.get(e))}),a.setter(b,function(b){return null==c.get(b.id)&&c.create(b),a.set(e,b.id)}),a.on("change:"+e,function(){var d,f;return d=a.get(b),f=c.get(a.previous(e)),d!==f?(a.stopListening(f),a.trigger("change:"+b,a,d),a.listenTo(d,"change:id",function(b,c){return a.set(e,c)})):void 0}),null!=f?a.set(b,f):null!=d?a.set(e,d):void 0}}(this)(b,c));return d},hasOne:function(){},hasMany:function(b){var c,d,e;e=[];for(c in b)d=b[c],e.push(function(b){return function(c,d){var e,f;return f=_(b.constuctor.name).underscored()+"_id",e=new a.Collection(null,{model:d,parent:b}),b.set(c,e),e.add(d.all().find(function(a){return a.get(f)===b.id})),d.all().on("change:"+f,function(a,c){return c!==b.id&&e.contains(a)?e.remove(a):c!==b.id||e.contains(a)?void 0:e.add(a)}),d.all().on("add",function(a){return a.get(f)!==b.id||e.contains(a)?void 0:e.add(a)}),d.all().on("remove",function(a){return a.get(f)===b.id&&e.contains(a)?e.remove(a):void 0}),e.on("add",function(a){return a.get(f)!==b.id?a.set(f,b.id):void 0}),e.on("remove",function(a){return a.get(f)===b.id?a.set(f,null):void 0})}}(this)(c,d));return e}},ClassMethods:{belongsTo:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.belongsTo(a.call(this))}}):this.prototype.belongsTo(a)},hasOne:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.hasOne(a.call(this))}}):this.prototype.hasOne(a)},hasMany:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.hasMany(a.call(this))}}):this.prototype.hasMany(a)}},extended:function(){return this.concern(a.Mixins.Collectable),this.concern(a.Mixins.Interceptable),this.concern(a.Mixins.DynamicProperties)}},a.Mixable={include:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._includedMixins)?i.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._includedMixins,d)<0){j=_.extend({},d.InstanceMethods,d.ObjectMethods);for(a in j)f=j[a],this.prototype[a]=f;this._includedMixins.push(d),null!=(k=d.included)&&k.apply(this)}return this},extend:function(){var a,d,e,f,g,h,i,j,k;for(e=1<=arguments.length?b.call(arguments,0):[],(null!=(i=this._extendedMixins)?i.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),g=0,h=e.length;h>g;g++)if(d=e[g],c.call(this._extendedMixins,d)<0){j=_.extend({},d.ClassMethods,d.ObjectMethods);for(a in j)f=j[a],this[a]=f;this._extendedMixins.push(d),null!=(k=d.extended)&&k.apply(this)}return this},concern:function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],this.extend.apply(this,a),this.include.apply(this,a),this}},a.Model=function(c){function d(){return d.__super__.constructor.apply(this,arguments)}return e(d,c),_.extend(d,a.Mixable),d.concern(a.Mixins.DynamicProperties),d.prototype.syncing=!1,d.prototype.dataType="json",d.prototype.initialize=function(a,b){return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent,this.synced=b.synced||!1,this.on("change",function(a){return function(b){var c,d,e,f;a.synced=!1,e=b.changed,f=[];for(c in e)d=e[c],a.hasOwnProperty(c.camelize(!0))||f.push(function(b){return a.getter(b.camelize(!0),function(){return a.get(b)}),a.setter(b.camelize(!0),function(c){return a.set(b,c)})}(c));return f}}(this)),this.on("sync",function(){return this.synced=!0}),d.__super__.initialize.apply(this,arguments)},d.prototype.urlRoot=function(){return"/"+this.constructor.name.pluralize().underscore()},d.prototype.url=function(){var b,c,d,e,f,g,h;return b=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||a.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+b+e+d+c},d.prototype.fetch=function(a){var c,e,f;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(_.defaults(a,{dataType:this.format}),e=d.__super__.fetch.call(this,a),this.synced=!1,this.syncing=!0,c=Q.defer(),f=function(a){return function(){var d;return d=1<=arguments.length?b.call(arguments,0):[],a.syncing=!1,c.resolve.apply(c,d)}}(this),e.then(function(a){return function(){var c;return c=1<=arguments.length?b.call(arguments,0):[],a.synced?f.apply(a,c):a.once("sync",function(){return f.apply(this,c)})}}(this)),e.fail(function(){return function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],c.reject.apply(c,a)}}(this)),this._fetchPromise=c.promise)},d.prototype.save=function(a){var c,e,f;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(_.defaults(a,{dataType:this.format}),e=d.__super__.save.call(this,a),this.synced=!1,this.syncing=!0,c=Q.defer(),f=function(a){return function(){var d;return d=1<=arguments.length?b.call(arguments,0):[],a.syncing=!1,c.resolve.apply(c,d)}}(this),e.then(function(a){return function(){var c;return c=1<=arguments.length?b.call(arguments,0):[],a.synced?f.apply(a,c):a.once("sync",function(){return f.apply(this,c)})}}(this)),e.fail(function(){return function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],c.reject.apply(c,a)}}(this)),this._fetchPromise=c.promise)},d.prototype.toJSON=function(){return _.omit(this.attributes,this._blacklistedAttributes)},d}(Backbone.Deferred.Model),a.Collection=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.model=null,c.prototype.syncing=!1,c.prototype.dataType="json",c.prototype.initialize=function(b,d){return null==b&&(b=null),null==d&&(d={}),this.model=d.model||this.model||a.Models[this.constructor.name.singularize()]||a.Model,this.parent=d.parent||this.parent,this.synced=d.synced||!1,this.on("sync",function(){return this.synced=!0}),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return"/"+this.model.name.pluralize().underscore()},c.prototype.url=function(){var b,c,d,e,f,g;return b=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||a.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+b+d+c},c.prototype.fetch=function(a){var b,d,e;return null==a&&(a={}),this.synced&&!a.force?this._fetchPromise:(this.syncing=!0,this.synced=!1,_.defaults(a,{dataType:this.format}),d=c.__super__.fetch.call(this,a),b=Q.defer(),e=function(a){return function(){return a.syncing=!1,b.resolve(a)}}(this),d.then(function(a){return function(){return a.synced?e():a.once("sync",function(){return e()})}}(this)),this._fetchPromise=b.promise)},c.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),c.synced=!0,d.push(c)}return d},c}(Backbone.Deferred.Collection),a.Template=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.concern(a.Mixins.Collectable),c.prototype.urlRoot="/assets",c.prototype.format="html",c.prototype.initialize=function(a,b){return null==a&&(a={}),null==b&&(b={}),c.__super__.initialize.apply(this,arguments)},c.prototype.bind=function(a){return this.fetch().then(function(b){return function(){var c;return c=b.$el.clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(a.Model),a.View=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),_.extend(c,a.Mixable),c.prototype.initialize=function(a){var b;return null==a&&(a={}),null!=(b=this.template)&&b.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.apply(this,arguments)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),a.factory=function(b){return b._=a,b.Mixable=a.Mixable,b.Model=a.Model,b.Collection=a.Collection,b.View=a.View,b.Template=a.Template,b.Mixins=a.Mixins,b.Models=a.Models,b.Views=a.Views,b.config=a.config,b.configure=function(b){var c,d;null==b&&(b={});for(c in b)d=b[c],a.config[c]=d}},"object"==typeof exports?a.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(b){return a.factory(this.Tails=b),b}):a.factory(this.Tails={})}).call(this);