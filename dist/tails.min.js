// Tails
// version: 0.0.2
// contributors: Joost Verdoorn,Steffan Sluis
// license: MIT
(function(){var a,b,c=[].slice,d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},e={}.hasOwnProperty,f={}.__proto__.constructor.defineProperty,g={}.__proto__.constructor.getOwnPropertyDescriptor,h=function(a,b){function c(){this.constructor=a}for(var d in b)e.call(b,d)&&f(a,d,g(b,d));return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};b={Mixins:{},Utils:{},Models:{},Views:{},config:{url:"http://localhost"}},b.Utils.Hash=function(a){var b,c,d,e,f;if(c=0,0===a.length)return c;for(d=e=0,f=a.length;f>=0?f>e:e>f;d=f>=0?++e:--e)b=a.charCodeAt(d),c=(c<<5)-c+b,c&=c;return c},b.Mixins.Interceptable={InstanceMethods:{before:function(a){return this.intercept({before:a})},after:function(a){return this.intercept({after:a})},intercept:function(a){var b,d,e,f,g,h,i,j,k,l,m,n;h=this.constructor||this,n=[];for(i in a)if(e=a[i],"before"===i||"after"===i){if(null!=e.these)for(m=e.these,k=0,l=m.length;l>k;k++){if(g=m[k],"function"==typeof g)for(f in this)if(j=this[f],g===j){g=f;break}e[g]=e["do"]}e=_(e).omit("these","do"),n.push(function(){var a;a=[];for(g in e)d=e[g],_(d).isArray()||(d=[d]),a.push(function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)b=d[a],f.push(function(a){return function(b,d){var e,f,g,j,k,l,m,n;return(a.hasOwnProperty(b)||h.prototype.hasOwnProperty(b))&&null==a[b].before&&null==a[b].after?(g=a[b],a[b]=function(){var a,b;return a=1<=arguments.length?c.call(arguments,0):[],"before"===i&&(this[d]||d).apply(this,a),b=g.apply(this,a),"after"===i&&(this[d]||d).apply(this,a),b}):(f=(null!=(k=a[b])?k.klass:void 0)===h&&null!=(l=a[b])?l.before:void 0,e=(null!=(m=a[b])?m.klass:void 0)===h&&null!=(n=a[b])?n.after:void 0,"before"===i?(j=f,f=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],null!=j&&j.apply(this,a),(this[d]||d).apply(this,a)}):"after"===i&&(j=e,e=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],(this[d]||d).apply(this,a),null!=j?j.apply(this,a):void 0}),Object.defineProperty(a,b,{configurable:!0,set:function(a){return delete this[b],this[b]=function(){var b,d;return b=1<=arguments.length?c.call(arguments,0):[],null!=f&&f.apply(this,b),d=a.apply(this,b),null!=e&&e.apply(this,b),d}},get:function(){var a;return a=function(){var a,d,g,i;return a=1<=arguments.length?c.call(arguments,0):[],null!=f&&f.apply(this,a),g=null!=(i=this.constructor.__super__)?i[b]:void 0,(null!=g?g.klass:void 0)!==h&&(d=null!=g?g.apply(this,a):void 0),null!=e&&e.apply(this,a),d},a.before=f,a.after=e,a.klass=h,a}}))}}(this)(g,b));return f}.call(this));return a}.call(this))}return n}},ClassMethods:{before:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.before(a.call(this))}}):this.prototype.before(a)},after:function(a){return null!=("function"==typeof a?a():void 0)?this.before({initialize:function(){return this.after(a.call(this))}}):this.prototype.after(a)}}},b.Mixable={MixableKeywords:["included","extended","constructor","Interactions","InstanceMethods","ClassMethods"],_include:function(a){var c,e,f,g;if(null!=a.InstanceMethods)c=a.InstanceMethods;else{if(null!=a.ClassMethods)return;c=a}for(e in c)f=c[e],d.call(b.Mixable.MixableKeywords,e)<0&&null!=f&&(this.prototype[e]=f);return null!=(g=c.included)?g.apply(this):void 0},_extend:function(a){var c,e,f,g;if(null!=a.ClassMethods)c=a.ClassMethods;else{if(null!=a.InstanceMethods)return;c=a}for(e in c)f=c[e],d.call(b.Mixable.MixableKeywords,e)<0&&null!=f&&(this[e]=f);return null!=(g=c.extended)?g.apply(this):void 0},include:function(){var a,b,e,f,g,h,i,j,k;for(e=1<=arguments.length?c.call(arguments,0):[],(null!=(j=this._includedMixins)?j.klass:void 0)!==this&&(this._includedMixins=_(this._includedMixins).clone()||[],this._includedMixins.klass=this),f=0,h=e.length;h>f;f++)b=e[f],d.call(this._includedMixins,b)>=0||(null!=b&&this._includedMixins.push(b),this._include(b),null!=b.Interactions&&(a=b.Interactions.apply(this),null!=a&&this._include(a)));for(k=this._includedMixins,g=0,i=k.length;i>g;g++)b=k[g],null!=b.Interactions&&(a=b.Interactions.apply(this),null!=a&&this._include(a));return this},extend:function(){var a,b,e,f,g,h,i,j,k;for(e=1<=arguments.length?c.call(arguments,0):[],(null!=(j=this._extendedMixins)?j.klass:void 0)!==this&&(this._extendedMixins=_(this._extendedMixins).clone()||[],this._extendedMixins.klass=this),f=0,h=e.length;h>f;f++)b=e[f],d.call(this._extendedMixins,b)>=0||(null!=b&&this._extendedMixins.push(b),this._extend(b),null!=b.Interactions&&(a=b.Interactions.apply(this),null!=a&&this._extend(a)));for(k=this._extendedMixins,g=0,i=k.length;i>g;g++)b=k[g],null!=b.Interactions&&(a=b.Interactions.apply(this),null!=a&&this._extend(a));return this},"with":function(a,b){return null==b&&(b={}),d.call(this._includedMixins,a)>=0||d.call(this._extendedMixins,a)>=0?b:null},concern:function(){var a,b,d,e;for(b=1<=arguments.length?c.call(arguments,0):[],d=0,e=b.length;e>d;d++)a=b[d],this.include(a),this.extend(a);return this}},b.Mixins.DynamicAttributes={InstanceMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({getter:a})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.defineAttribute({setter:a})},lazy:function(a,b){var c,d,e;null==b&&(b=null),"string"==typeof a&&null!=b&&(d=a,(a={})[d]=b),e=[];for(c in a)b=a[c],e.push(function(a){return function(b,c){var d,e;return(d={})[b]=function(){return this.attributes[b]=c()},(e={})[b]=function(a){return delete this.attributes[b],this.attributes[b]=a},a.getter(d),a.setter(e)}}(this)(c,b));return e},defineAttribute:function(a){var b,c,d,e,f;f=[];for(e in a)b=a[e],("getter"===e||"setter"===e)&&f.push(function(){var a;a=[];for(d in b)c=b[d],a.push(function(a){return function(b,c){var d;return d=Object.getOwnPropertyDescriptor(a.attributes,b)||{configurable:!0},"getter"===e?d.get=function(){return c.call(a)}:"setter"===e&&(d.set=function(b){return c.call(a,b)}),Object.defineProperty(a.attributes,b,d)}}(this)(d,c));return a}.call(this));return f}},ClassMethods:{getter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.getter(("function"==typeof a?a():void 0)||a)}})},setter:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.setter(("function"==typeof a?a():void 0)||a)}})},lazy:function(a,b){var c;return null==b&&(b=null),"string"==typeof a&&null!=b&&(c=a,(a={})[c]=b),this.before({initialize:function(){return this.lazy(("function"==typeof a?a():void 0)||a)}})},extended:function(){return this.concern(b.Mixins.Interceptable)}}},b.Collection=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),_.extend(c,b.Mixable),c.prototype.format="json",c.prototype.initialize=function(a,d){return null==a&&(a=null),null==d&&(d={}),this.model=d.model||this.model||b.Model,this.parent=d.parent||this.parent,c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.model.name,["underscore","pluralize"])},c.prototype.url=function(){var a,c,d,e,f,g;return a=(null!=(f=this.parent)&&"function"==typeof f.url?f.url():void 0)||(null!=(g=this.parent)?g.url:void 0)||b.url,d=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",e=""+a+"/"+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.parse=function(a){var b,c,d,e,f;for(d=[],e=0,f=a.length;f>e;e++){if(b=a[e],b instanceof Backbone.Model){d.push(b);break}c=this.model.get(b.id),c.set(b),d.push(c)}return d},c}(Backbone.Deferred.Collection),b.Mixins.Collectable={InstanceMethods:{included:function(){return this.concern(b.Mixins.Interceptable),this.after({initialize:function(){if(null!=this.id&&null!=this.constructor.collection().get(this.id))throw new Error("Duplicate "+this.constructor.name+" for id "+this.id+".");return this.constructor.add(this)}})}},ClassMethods:{collection:function(){var a;return(null!=(a=this._collection)?a.klass:void 0)!==this&&(this._collection=new b.Collection(null,{model:this}),this._collection.klass=this),this._collection},get:function(a){return this.collection().get(a)||new this({id:a})},scope:function(a,c){var d,e,f,g;"string"!=typeof a&&(c=a),e=new b.Collection(this.collection().where(c.where),{model:this,parent:this}),g=c.where;for(d in g)f=g[d],this.collection().on("change:"+d,function(){return function(a,b){return b!==f&&e.contains(a)?e.remove(a):b!==f||e.contains(a)?void 0:e.add(a)}}(this)),this.collection().on("add",function(){return function(a){return a.get(d)!==f||e.contains(a)?void 0:e.add(a)}}(this)),this.collection().on("remove",function(){return function(a){return a.get(d)===f&&e.contains(a)?e.remove(a):void 0}}(this)),e.on("add",function(){return function(a){return a.get(d)!==f?a.set(d,f):void 0}}(this)),e.on("remove",function(){return function(a){return a.get(d)===f?a.set(d,void 0):void 0}}(this));return null!=a&&(this[a]=e),e},extended:function(){var a,b,d,e,f;for(b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample","add","remove","set","at","push","pop","unshift","shift","slice","sort","pluck","where","findWhere","clone","create","fetch","reset","urlRoot","on","off","once","trigger","listenTo","stopListening","listenOnce"],f=[],d=0,e=b.length;e>d;d++)a=b[d],f.push(function(a){return function(b){return a[b]=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],this.collection()[b].apply(this.collection(),a)}}}(this)(a));return f}},Interactions:function(){return{ClassMethods:this["with"](b.Mixins.Storage,{extended:function(){return this.collection().on("add remove",function(a){return function(b){return null!=b.id?a.store():void 0}}(this))}})}}},b.Mixins.Relations={InstanceMethods:{belongsTo:function(a,b){var c,d,e,f;return null==b&&(b={}),c=b.attribute||inflection.camelize(a.name,!0),e=b.foreignKey||inflection.foreign_key(a.name),d=this.get(e),f=this.get(c),this.unset(e,{silent:!0}),this.unset(c,{silent:!0}),this.getter(c,function(b){return function(){return a.get(b.get(e))||new a({id:b.get(e)})}}(this)),this.setter(c,function(b){return function(c){return null==c?b.unset(e):(null==a.get(c.id)&&a.create(c),b.set(e,c.id))}}(this)),this.on("change:"+e,function(b){return function(){var d,f;return d=b.get(c),f=a.get(b.previous(e)),null!=d&&d!==f?(f&&b.stopListening(f),b.trigger("change:"+c,b,d),b.listenTo(d,"change:id",function(a,c){return b.set(e,c)})):void 0}}(this)),null!=f?this.set(c,f):null!=d?this.set(e,d):void 0},hasOne:function(a,b){var c,d,e;return null==b&&(b={}),c=b.attribute||inflection.camelize(a.name,!0),e=b.foreignKey||inflection.foreign_key(this.constructor.name),d={},d[e]=this.id,this.getter(c,function(){return function(){return a.findWhere(d)||new a(d)}}(this)),this.setter(c,function(a){return function(b){return a.attributes(c)[e]=void 0,b[e]=a.id}}(this))},hasMany:function(a,b){var c,d,e;return null==b&&(b={}),c=b.attribute||inflection.camelize(a.name),d=b.foreignKey||inflection.foreign_key(this.constructor.name),(e={})[d]=this.id,this.lazy(c,function(){return a.scope({where:e})})},addRelation:function(a,b,c){switch(null==c&&(c={}),b){case"belongsTo":return this.belongsTo(a,c);case"hasOne":return this.hasOne(a,c);case"hasMany":return this.hasMany(a,c)}}},ClassMethods:{belongsTo:function(a){return this.addRelation("belongsTo",a)},hasOne:function(a){return this.addRelation("hasOne",a)},hasMany:function(a){return this.addRelation("hasMany",a)},addRelation:function(b,c){var d,e,f;return d=_(c).keys()[0],f=c[d],c=_(c).pick("foreignKey","through","source"),c.attribute=d,e=new a({owner:this,type:b,options:c}),f.prototype instanceof Backbone.Model?e.set({target:f}):e.getter({target:f})},relations:function(){return a.collection().where({owner:this})},extended:function(){return this.concern(b.Mixins.DynamicAttributes),this.concern(b.Mixins.Collectable),this.concern(b.Mixins.Interceptable),this.before({initialize:function(){var a,b,c,d,e,f,g,h;for(g=this.constructor.relations(),h=[],e=0,f=g.length;f>e;e++)b=g[e],c=b.get("target"),d=b.get("type"),a=b.get("options"),h.push(this.addRelation(c,d,a));return h}})}}},a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),_.extend(c,b.Mixable),c.concern(b.Mixins.DynamicAttributes),c.concern(b.Mixins.Collectable),c}(Backbone.Model),b.Mixins.Storage={InstanceMethods:{storage:function(){return this.constructor.storage()},indexRoot:function(){return this.constructor.indexRoot()},store:function(a){return this.constructor.store(this,a)},retrieve:function(a){return _.defaults(this.attributes,this.constructor.retrieve(this.id,a))},included:function(){return this.concern(b.Mixins.Interceptable),this.after({initialize:function(){return this.on("sync",this.store),this.retrieve(),this.store()}})}},ClassMethods:{storage:function(){return localStorage},toJSON:function(a){return("function"==typeof a.has?a.has("$el"):void 0)&&(a.get("$el").toJSON=function(){return this.clone().wrap("<div/>").parent().html()}),JSON.stringify(a)},indexRoot:function(){return inflection.transform(this.name,["underscore","pluralize"])},store:function(a,c){var d,e,f,g;if(null!=a&&null!=a.id)return d=null!=(g="function"==typeof this.indexRoot?this.indexRoot():void 0)?g:this.indexRoot,f=""+d+"/"+a.id,null!=c?(f+="/"+b.Utils.Hash(this.toJSON(c)),e=this.toJSON({instance:a,data:c})):e=this.toJSON(a),this.storage().setItem(f,e),f},retrieve:function(a,c){var d,e,f,g,h,i,j;if(e=null!=(j="function"==typeof this.indexRoot?this.indexRoot():void 0)?j:this.indexRoot,null==a){if(f=this.storage().getItem(b.Utils.Hash(e)),d=JSON.parse(f),null!=f)for(h=0,i=d.length;i>h;h++)a=d[h],this.retrieve(a);return d}return g=""+e+"/"+a,null!=c&&(g+="/"+c),f=this.storage().getItem(g),null!=f?JSON.parse(f):void 0}},Interactions:function(){return{InstanceMethods:this["with"](b.Mixins.Debug,{included:function(a){return function(){return a.after({initialize:function(){return console.log(this.toJSON(this.name)),this.after({store:function(){return this.log("Stored instances",this.constructor.pluck("id"))}})}})}}(this)}),ClassMethods:this["with"](b.Mixins.Collectable,{indexRoot:function(){var a;return null!=(a="function"==typeof this.urlRoot?this.urlRoot():void 0)?a:this.urlRoot},extended:function(){return this.after({store:function(){var a,b,c;return b=null!=(c="function"==typeof this.indexRoot?this.indexRoot():void 0)?c:this.indexRoot,a=this.toJSON(this.constructor.pluck("id")),this.constructor.storage().setItem(b,a)}})}})}}},b.Mixins.History={Interactions:function(){return{InstanceMethods:this["with"](b.Mixins.Storage,{diff:function(){var a,b,c,d,e;a={},a.apply=function(b){return function(c){var d,e,f,g;null==c&&(c=b);for(e in a){d=a[e];for(f in d)switch(g=d[f],f){case"create":c.set(e,g.value);break;case"update":c.set(e,g["new"]);break;case"delete":c.unset(e)}}return c}}(this),c=this.constructor.retrieve(this.id)||{},e=this.attributes;for(b in e)d=e[b],c[b]!==this.get(b)&&(a[b]=null!=c[b]?{update:{old:c[b],"new":this.get(b)}}:{create:{value:this.get(b)}});for(b in c)d=c[b],this.has(b)||(a[b]={"delete":{value:d}});return a},commit:function(){var a;return a=this.store(this.diff())},included:function(){return this.after({initialize:function(){return this.on("change",this.commit)}})}})}}},b.Mixins.Debug={InstanceMethods:{LOG_LEVELS:{ERROR:!0,WARNING:!0,INFO:!1},_excludedMethods:_.union(Object.keys(b.Mixins.Interceptable.InstanceMethods),["constructor","log","message","warn","error","info"]),message:function(){var a,b,d,e,f;for(d=1<=arguments.length?c.call(arguments,0):[],a=""+new Date+" - ",e=0,f=d.length;f>e;e++)b=d[e],a+="String"===b.constructor.name?b+" ":JSON.stringify(b)+" ";return a+="in "+this.constructor.name+"("+this.id+")"},error:function(){var a,b;return b=1<=arguments.length?c.call(arguments,0):[],this.LOG_LEVELS.ERROR?(a=this.message.apply(this,b),console.error(a)):void 0},warn:function(){var a,b;return b=1<=arguments.length?c.call(arguments,0):[],this.LOG_LEVELS.WARNING?(a=this.message.apply(this,b),console.warn(a)):void 0},log:function(){var a,b;return b=1<=arguments.length?c.call(arguments,0):[],a=this.message.apply(this,b),console.log(a)},info:function(){var a,b;return b=1<=arguments.length?c.call(arguments,0):[],this.LOG_LEVELS.INFO?(a=this.message.apply(this,b),console.log(a)):void 0},included:function(){return this.concern(b.Mixins.Interceptable),this.after({initialize:function(){var a,b,e,f,g,h,i;for(a=1<=arguments.length?c.call(arguments,0):[],this.info("Called function 'initialize' of "+this.constructor.name+" with arguments:",a),this.on("change",function(a){return function(b){return a.info("Change of attributes:",b.changedAttributes())}}(this)),b=function(){var a;a=[];for(e in this)f=this[e],f instanceof Function&&d.call(this._excludedMethods,e)<0&&a.push(e);return a}.call(this),i=[],g=0,h=b.length;h>g;g++)e=b[g],i.push(function(a){return function(b){return a.after({these:[b],"do":function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],this.info("Called function '"+b+"' of "+this.constructor.name+" with arguments:",a)}})}}(this)(e));return i}})}}},b.Model=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),_.extend(c,b.Mixable),c.concern(b.Mixins.Relations),c.prototype.format="json",c.prototype.initialize=function(a,b){var d;return null==a&&(a={}),null==b&&(b={}),this.parent=b.parent||this.parent||(null!=(d=this.collection)?d.parent:void 0),c.__super__.initialize.apply(this,arguments)},c.prototype.urlRoot=function(){return inflection.transform(this.constructor.name,["underscore","pluralize"])},c.prototype.url=function(){var a,c,d,e,f,g,h;return a=(null!=(g=this.parent)&&"function"==typeof g.url?g.url():void 0)||(null!=(h=this.parent)?h.url:void 0)||b.config.url,e=("function"==typeof this.urlRoot?this.urlRoot():void 0)||this.urlRoot,d=this.id?"/"+this.id:"",c=null!=this.format?"."+(("function"==typeof this.format?this.format():void 0)||this.format):"",f=""+a+"/"+e+d+c},c.prototype.fetch=function(a){return null==a&&(a={}),c.__super__.fetch.call(this,_.defaults(a,{dataType:this.format}))},c.prototype.save=function(a){return null==a&&(a={}),c.__super__.save.call(this,_.defaults(a,{dataType:this.format}))},c}(Backbone.Deferred.Model),b.Template=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),c.concern(b.Mixins.Collectable),c.prototype.urlRoot="assets",c.prototype.format="html",c.prototype.bind=function(a){return this.fetch({parse:!0}).then(function(b){return function(){var c;return c=$(b.get("$el")).clone(),rivets.bind(c,a),c}}(this))},c.prototype.parse=function(a){return{$el:$(a)}},c}(b.Model),b.View=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),_.extend(c,b.Mixable),c.prototype.initialize=function(a){return null==a&&(a={}),this.template.constructor===String&&(this.template=b.Template.get(this.template)),this.template.bind(this).then(function(a){return function(b){return a.setElement(b),a.render()}}(this)),c.__super__.initialize.call(this,a)},c.prototype.render=function(){return this.delegateEvents()},c.prototype.setView=function(a){return this.view=a,this.view.render()},c}(Backbone.View),b.factory=function(a){return a._=b,a.Mixable=b.Mixable,a.Model=b.Model,a.Collection=b.Collection,a.View=b.View,a.Template=b.Template,a.Mixins=b.Mixins,a.Utils=b.Utils,a.Models=b.Models,a.Views=b.Views,a.config=b.config,a.configure=function(a){var c,d;null==a&&(a={});for(c in a)d=a[c],b.config[c]=d}},"object"==typeof exports?b.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(a){return b.factory(this.Tails=a),a}):b.factory(this.Tails={})}).call(this);